#!/usr/bin/env ruby
require 'gli'
require 'csv'
require 'sobriquet'

include GLI::App

program_desc 'Sobriquet manage your alias'

version Sobriquet::VERSION

subcommand_option_handling :normal
arguments :strict

desc 'Show more retroaction'
switch [:v, :verbose]

desc 'Path of the workspace foder for sobriquet'
default_value ENV['HOME']
arg_name 'workspace'
flag [:w, :workspace]

command :init do |command|
  command.action do |global_options, _options, _args|
    csv = global_options['workspace'] + '/sobriquet.csv'
    puts 'Initialise a new sobriquet workspace in ' + csv
    template_path = File.expand_path('../../templates/sobriquet.csv', __FILE__)
    FileUtils.cp template_path, csv
  end
end

arg :sobriquet
arg :command
command :add do |command|
  command.desc 'Description of the alias'
  command.default_value 'no descriptions'
  command.arg_name 'a bad description is better than no description'
  command.flag [:d, :description]
  command.action do |global_options, options, args|
    csv = global_options['workspace'] + '/sobriquet.csv'
    description = options['description']
    sobriquet = args.shift
    command = args.shift
    CSV.open(csv, 'ab', col_sep: ' | ') do |c|
      c.add_row([command, sobriquet, description])
    end
    puts "Added new sobriquet #{sobriquet} | #{command}"
  end
end

command :generate do |command|
  command.action do |global_options, _options, _args|
    csv = global_options['workspace'] + '/sobriquet.csv'
    shell_path = global_options['workspace'] + '/sobriquet.sh'
    File.open(shell_path, 'w') do |file|
      CSV.open(csv, 'rb', col_sep: ' | ', headers: true).map do |line|
        file.write "alias #{line[1]}='#{line[0]}'\n"
      end
    end
    puts 'generate alias file ' + shell_path + ' from csv file' + csv
  end
end

exit run(ARGV)
